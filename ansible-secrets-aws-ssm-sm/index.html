<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>Managing Ansible playbook secrets with AWS services - Oh my blog!</title>

  <!-- Edit site and author settings in `_config.yml` to make the social details your own -->

    <meta content="Oh my blog!" property="og:site_name">
  
    <meta content="Managing Ansible playbook secrets with AWS services" property="og:title">
  
  
    <meta content="article" property="og:type">
  
  
    <meta content="A place where I talk with internet
" property="og:description">
  
  
    <meta content="https://serhii.vasylenko.info/ansible-secrets-aws-ssm-sm/" property="og:url">
  
  
    <meta content="2020-08-06T00:00:00+00:00" property="article:published_time">
    <meta content="https://serhii.vasylenko.info/about/" property="article:author">
  
  
    <meta content="https://serhii.vasylenko.info/assets/img/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png" property="og:image">
  
  
    
  
  
    
    <meta content="ansible" property="article:tag">
    
    <meta content="aws" property="article:tag">
    
    <meta content="devops" property="article:tag">
    
    <meta content="security" property="article:tag">
    
  
    <meta name="twitter:card" content="Serhii Vasylenko. Oh my blog!">
    <meta name="twitter:site" content="@vasylenko">
    <meta name="twitter:creator" content="@vasylenko">
  
    <meta name="twitter:title" content="Managing Ansible playbook secrets with AWS services">
  
  
    <meta name="twitter:url" content="https://serhii.vasylenko.info/ansible-secrets-aws-ssm-sm/">
  
  
    <meta name="twitter:description" content="A place where I talk with internet
">
  
  
    <meta name="twitter:image:src" content="https://serhii.vasylenko.info/assets/img/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png">
  

	<meta name="description" content="">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
	<meta property="og:image" content="">
	<link rel="shortcut icon" href="/assets/img/favicon/favicon.ico" type="image/x-icon">
	<link rel="apple-touch-icon" href="/assets/img/favicon/apple-touch-icon.png">
	<!-- Chrome, Firefox OS and Opera -->
	<meta name="theme-color" content="#263959">
	<!-- Windows Phone -->
	<meta name="msapplication-navbutton-color" content="#263959">
	<!-- iOS Safari -->
	<meta name="apple-mobile-web-app-status-bar-style" content="#263959">
	<!-- Google Fonts -->
	<link href="https://fonts.googleapis.com/css?family=PT+Serif:400,700" rel="stylesheet">
	<link href="https://fonts.googleapis.com/css?family=Lato:300,400,700" rel="stylesheet">
	<!-- Font Awesome -->
	<link rel="stylesheet" href="/assets/fonts/font-awesome/css/font-awesome.min.css">
	<!-- Styles -->
	<link rel="stylesheet" href="/assets/css/main.css">
</head>

<body>

  <div class="wrapper">
    <aside class="sidebar">
  <header>
    <div class="about">
      <div class="cover-author-image">
        <a href="/"><img src="/assets/img/serhii-vasylenko.jpeg" alt="Serhii Vasylenko"></a>
      </div>
      <div class="author-name">Serhii Vasylenko</div>
      <p>Teamlead, engineer, geek.</p>
    </div>
  </header> <!-- End Header -->
  <footer>
    <section class="contact">
      <h3 class="contact-title">Contact me</h3>
      <ul>
        
          <li><a href="https://facebook.com/vasylenkos" target="_blank"><i class="fa fa-facebook" aria-hidden="true"></i></a></li>
        
        
          <li><a href="https://twitter.com/vasylenko" target="_blank"><i class="fa fa-twitter" aria-hidden="true"></i></a></li>
               
        
          <li class="github"><a href="http://github.com/vasylenko" target="_blank"><i class="fa fa-github"></i></a></li>
        
        
          <li class="linkedin"><a href="https://in.linkedin.com/in/svasylenko" target="_blank"><i class="fa fa-linkedin"></i></a></li>
        
        
          <li class="email"><a href="mailto:contacts@vasylenko.info"><i class="fa fa-envelope-o"></i></a></li>
        
      </ul>
    </section> <!-- End Section Contact -->
    <!-- <div class="copyright">
      <p>2020 &copy; Serhii Vasylenko</p>
    </div> -->
  </footer> <!-- End Footer -->
</aside> <!-- End Sidebar -->
<div class="content-box clearfix">
  <article class="article-page">
  <div class="page-content" id="page-content">
    
    <div class="page-cover-image">
      <figure>
        <img class="page-image" src=/assets/img/posts/2020-08-06-ansible-secrets-aws-ssm-sm.png alt="Managing Ansible playbook secrets with AWS services">
        
      </figure>
    </div> <!-- End Page Cover Image -->
    
    <div class="wrap-content">
      <header class="header-page">
        <h1 class="page-title">Managing Ansible playbook secrets with AWS services</h1>
        <div class="page-date"><span>2020, Aug 06&nbsp;&nbsp;&nbsp;&nbsp;</span></div>
      </header>
      <h2 id="intro">Intro</h2>
<p>Lookup plugins for Ansible allow you to do a lot of cool things. One of them is to securely pass sensitive information to your playbooks. 
If you manage some apps in AWS with Ansible, then using Parameter Store or Secrets Manager along with it might greatly improve your security.<br />
Also, you can (or even should) use SSM Parameter Store to keep all your variables related to environment settings – this is what this service was made for and this is why it’s called “<strong>Parameter</strong> Store”</p>

<h2 id="variables-with-ssm-parameter-store">Variables with SSM Parameter Store</h2>

<p>Let’s say you have some variables defined in ‘defaults/main.yaml’ file of your role or maybe in group_vars.yaml file.</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
<span class="c1"># content of dev.vars.yaml to be included in your play or role</span>
<span class="na">use_tls</span><span class="pi">:</span> <span class="no">true</span>
<span class="na">application_port</span><span class="pi">:</span> <span class="m">3000</span>
<span class="na">app_env</span><span class="pi">:</span> <span class="s">development</span>
<span class="na">stripe_api_key</span><span class="pi">:</span> <span class="s">1HGASU2eZvKYlo2CT5MEcnC39HqLyjWD</span>
</code></pre></div></div>

<p>If you store such things locally on Ansible control node, you probably encrypt it with <a href="https://docs.ansible.com/ansible/latest/user_guide/vault.html">ansible-vault</a></p>

<p>SSM Parameter Store gives you more flexibility and security by centralized storage and management of parameters and secrets, so let’s use it with Ansible:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># content of dev.vars.yaml to be included in your play or role</span>
<span class="na">use_tls</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/use_tls')}}"</span>
<span class="na">application_port</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/application_port')}}"</span>
<span class="na">app_env</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/app_env')}}"</span>
<span class="na">stripe_api_key</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{lookup('aws_ssm',</span><span class="nv"> </span><span class="s">'/dev/webserver/stripe_api_key')}}"</span>
</code></pre></div></div>
<p>The syntax is fairly simple:</p>

<p>The <code class="language-plaintext highlighter-rouge">aws_ssm</code> argument – is the name of plugin.</p>

<p>The <code class="language-plaintext highlighter-rouge">/dev/webserver/use_tls</code> argument – is the path to the key in Paramter Store.</p>

<p>Surely you can do the same for a group of servers with group variables, for example:</p>

<p>You can use this anywhere you can use templating: in a play, in variables file, or a Jinja2 template.</p>

<h2 id="variables-with-secret-manager">Variables with Secret Manager</h2>

<p>Another cool lookup plugin is Secrets Manager. In a nutshell, it has the same kind of functionality but it uses JSON format by feault.</p>

<p>Here is a quick example of its functionality in a Playbook:</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Extract something secrets from Secret Manager</span>
  <span class="na">debug</span><span class="pi">:</span>
    <span class="na">msg</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">lookup('aws_secret',</span><span class="nv"> </span><span class="s">'dev/some-secrets')}}"</span>
</code></pre></div></div>
<p>The above task will generate the following output</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>TASK [Extract something secrets from Secret Manager] ****************************************************
ok: [some_server] =&gt; {
    "msg": {
        "dbname": "database",
        "engine": "mysql",
        "host": "127.0.0.1",
        "password": "password",
        "port": "3306",
        "username": "db_user"
    }
}
</code></pre></div></div>
<p>This is nice if you want to insert a JSON as is, but you will need additional parsing in case you want to get only some of JSON elements.</p>

<h2 id="conclusion">Conclusion</h2>

<p>If you’re using Ansible in CI/CD, then having it on an EC2 Instance with the IAM role will make you avoid keeping any secrets on that instance at all.<br />
The IAM role must allow at least the read access to SSM Parameter Store (+ KMS read access to be able to decrypt the keys) or the read access to Secrets Manager.</p>

<p>You can find documentation for described plugins here <a href="https://docs.ansible.com/ansible/latest/plugins/lookup/aws_ssm.html">aws_ssm</a> and here <a href="https://docs.ansible.com/ansible/latest/plugins/lookup/aws_secret.html">aws_secret</a>.</p>

<p>More about lookup plugins: https://docs.ansible.com/ansible/latest/plugins/lookup.html</p>

      <div class="page-footer">
        <!-- <div class="page-share">
          <a href="https://twitter.com/intent/tweet?text=Managing Ansible playbook secrets with AWS services&url=https://serhii.vasylenko.info/ansible-secrets-aws-ssm-sm/" title="Share on Twitter" rel="nofollow" target="_blank">Twitter</a>
          <a href="https://facebook.com/sharer.php?u=https://serhii.vasylenko.info/ansible-secrets-aws-ssm-sm/" title="Share on Facebook" rel="nofollow" target="_blank">Facebook</a>
          <a href="https://plus.google.com/share?url=https://serhii.vasylenko.info/ansible-secrets-aws-ssm-sm/" title="Share on Google+" rel="nofollow" target="_blank">Google+</a>
        </div> -->
        <div class="page-tag">
          
            <a href="/tags#ansible" class="tag">&#35; ansible</a>
          
            <a href="/tags#aws" class="tag">&#35; aws</a>
          
            <a href="/tags#devops" class="tag">&#35; devops</a>
          
            <a href="/tags#security" class="tag">&#35; security</a>
          
        </div>
      </div>
      <section class="comment-area">
  <div class="comment-wrapper">
    
    <div id="disqus_thread" class="article-comments"></div>
    <script>
      (function() {
          var d = document, s = d.createElement('script');
          s.src = '//serhii-vasylenko-info.disqus.com/embed.js';
          s.setAttribute('data-timestamp', +new Date());
          (d.head || d.body).appendChild(s);
      })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    
  </div>
</section> <!-- End Comment Area -->

    </div> <!-- End Wrap Content -->
  </div> <!-- End Page Content -->
</article> <!-- End Article Page -->

</div>

  </div>
  
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-GK7SE0XWGK"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-GK7SE0XWGK');
</script>

<!-- Thank you Artem for this nice Jekyll theme! https://github.com/artemsheludko/flexible-jekyll -->
</body>
</html>
